# ğŸ“Š Project Architecture & Payment Integration Visual Guide

## Current Architecture

```
SAMUI TRANSFERS - Current Stack (Phase 1 Complete)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      FRONTEND (Next.js 15)                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  Pages:                    Components:                     â”‚
â”‚  â”œâ”€ / (Home)              â”œâ”€ Booking Form                 â”‚
â”‚  â”œâ”€ /sign-in âœ…           â”œâ”€ Payment Form ğŸ”²              â”‚
â”‚  â”œâ”€ /sign-up              â”œâ”€ Admin Dashboard ğŸ”²           â”‚
â”‚  â”œâ”€ /booking              â””â”€ ... 20+ components          â”‚
â”‚  â”œâ”€ /dashboard âœ…                                         â”‚
â”‚  â”œâ”€ /admin âœ…             Styling:                       â”‚
â”‚  â””â”€ /about                â””â”€ Tailwind CSS + DaisyUI     â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      API LAYER (14 endpoints)               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  Authentication:           Payments:                      â”‚
â”‚  â”œâ”€ POST /auth/signin      â”œâ”€ POST create-intent         â”‚
â”‚  â”œâ”€ POST /auth/signout     â”œâ”€ POST confirm ğŸ”²            â”‚
â”‚  â””â”€ GET /auth/session      â”œâ”€ GET status/:id             â”‚
â”‚                            â””â”€ POST webhook               â”‚
â”‚  Booking:                  Admin:                        â”‚
â”‚  â”œâ”€ POST /bookings         â”œâ”€ CRUD rates                 â”‚
â”‚  â”œâ”€ GET /bookings/:id      â””â”€ Dashboard ğŸ”²              â”‚
â”‚  â””â”€ PUT /bookings/:id                                   â”‚
â”‚                            Utilities:                    â”‚
â”‚  Rates:                    â”œâ”€ POST /debug                â”‚
â”‚  â”œâ”€ POST /calculate        â””â”€ POST /fix-test-user       â”‚
â”‚  â”œâ”€ GET /active                                        â”‚
â”‚  â””â”€ CRUD /admin/rates                                  â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    BUSINESS LOGIC LAYER                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  lib/stripe.ts âœ…             lib/rates.ts âœ…             â”‚
â”‚  â”œâ”€ createPaymentIntent       â”œâ”€ calculateFare           â”‚
â”‚  â”œâ”€ confirmPayment            â”œâ”€ applyMultipliers        â”‚
â”‚  â”œâ”€ refundPayment             â”œâ”€ getPeakHourMultiplier  â”‚
â”‚  â””â”€ verifyWebhookSignature    â””â”€ getSeasonalMultiplier  â”‚
â”‚                                                             â”‚
â”‚  lib/auth.ts âœ…              lib/email.ts âœ…             â”‚
â”‚  â”œâ”€ NextAuth config          â”œâ”€ sendConfirmation        â”‚
â”‚  â”œâ”€ JWT callbacks            â”œâ”€ sendReceipt             â”‚
â”‚  â””â”€ Session strategy         â””â”€ sendNotification        â”‚
â”‚                                                             â”‚
â”‚  lib/db.ts âœ…                                             â”‚
â”‚  â””â”€ Prisma ORM client                                   â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      DATABASE (Neon PostgreSQL)             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  User âœ…                     Booking âœ…                   â”‚
â”‚  â”œâ”€ id, email, password      â”œâ”€ id, userId             â”‚
â”‚  â”œâ”€ name, role               â”œâ”€ pickupLocation         â”‚
â”‚  â”œâ”€ emailVerified            â”œâ”€ dropoffLocation        â”‚
â”‚  â””â”€ createdAt                â”œâ”€ vehicleType            â”‚
â”‚                              â”œâ”€ passengerCount         â”‚
â”‚  Account, Session            â”œâ”€ phoneNumber            â”‚
â”‚  â””â”€ NextAuth support         â”œâ”€ paymentStatus ğŸ’°       â”‚
â”‚                              â”œâ”€ paymentId ğŸ’°           â”‚
â”‚  ServiceRate âœ…              â”œâ”€ paymentAmount ğŸ’°        â”‚
â”‚  â”œâ”€ vehicleType              â”œâ”€ paymentMethod ğŸ’°        â”‚
â”‚  â”œâ”€ basePrice                â””â”€ paymentDate ğŸ’°          â”‚
â”‚  â”œâ”€ distanceRate                                       â”‚
â”‚  â””â”€ isActive                 PricingRule âœ…             â”‚
â”‚                              â”œâ”€ ruleType               â”‚
â”‚  RateHistory âœ…              â”œâ”€ multiplier             â”‚
â”‚  â”œâ”€ bookingId                â””â”€ isActive               â”‚
â”‚  â”œâ”€ appliedRules                                       â”‚
â”‚  â””â”€ finalPrice               AuditLog âœ…               â”‚
â”‚                              â””â”€ Event tracking         â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    EXTERNAL SERVICES                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  Stripe âœ…                   Google Maps âœ…              â”‚
â”‚  â”œâ”€ Payment processing       â”œâ”€ Geocoding              â”‚
â”‚  â”œâ”€ Webhook handling         â”œâ”€ Places autocomplete    â”‚
â”‚  â””â”€ PCI compliance           â””â”€ Distance matrix        â”‚
â”‚                                                             â”‚
â”‚  NextAuth âœ…                 Nodemailer âœ…              â”‚
â”‚  â”œâ”€ Authentication          â”œâ”€ Email delivery         â”‚
â”‚  â”œâ”€ Session management      â””â”€ Templates              â”‚
â”‚  â””â”€ JWT tokens                                        â”‚
â”‚                              PayPal ğŸ”² (Phase 2)       â”‚
â”‚  Neon Database âœ…           â””â”€ Payment processing     â”‚
â”‚  â””â”€ PostgreSQL hosting                                 â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    DEPLOYMENT                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  GitHub (rbac branch) â†’ Vercel â†’ Production            â”‚
â”‚  â”œâ”€ Source control          â”œâ”€ Build & deploy         â”‚
â”‚  â”œâ”€ Code review             â”œâ”€ Auto-scaling           â”‚
â”‚  â””â”€ Version history         â””â”€ CDN + serverless       â”‚
â”‚                                                             â”‚
â”‚  Environment Variables (3 critical):                   â”‚
â”‚  â”œâ”€ NEXTAUTH_URL = https://www.samui-transfers.com   â”‚
â”‚  â”œâ”€ NEXTAUTH_SECRET = 7799a51de...                   â”‚
â”‚  â””â”€ DATABASE_URL = postgresql://neondb_owner...      â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Legend:
âœ… = Complete & Working
ğŸ”² = Not started (Phase 2)
ğŸ”² = In progress
ğŸ’° = Payment-related
```

---

## Phase 2: Payment Gateway Architecture

```
PAYMENT INTEGRATION - What Gets Added
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              NEW PAYMENT COMPONENTS (Week 1-2)              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  components/payment/                                       â”‚
â”‚  â”œâ”€ StripeCheckout.tsx         (200 lines)               â”‚
â”‚  â”‚  â””â”€ Stripe Elements integration                       â”‚
â”‚  â”œâ”€ PaymentForm.tsx            (150 lines)               â”‚
â”‚  â”‚  â””â”€ Email + amount + submit                          â”‚
â”‚  â”œâ”€ PaymentStatus.tsx          (120 lines)               â”‚
â”‚  â”‚  â””â”€ Processing â†’ Success/Error                       â”‚
â”‚  â”œâ”€ PaymentMethodSelector.tsx  (150 lines)               â”‚
â”‚  â”‚  â””â”€ Stripe vs PayPal toggle                          â”‚
â”‚  â””â”€ PaymentSummary.tsx         (80 lines)                â”‚
â”‚     â””â”€ Price breakdown + total                          â”‚
â”‚                                                             â”‚
â”‚  hooks/                                                     â”‚
â”‚  â””â”€ usePayment.ts              (100 lines)                â”‚
â”‚     â””â”€ Payment state management                          â”‚
â”‚                                                             â”‚
â”‚  Total: ~800 lines of new React code                    â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              NEW PAGES (Week 1)                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  app/booking/payment/page.tsx     (250 lines)             â”‚
â”‚  â””â”€ Dedicated payment page                               â”‚
â”‚     â”œâ”€ Booking summary                                   â”‚
â”‚     â”œâ”€ Price breakdown                                   â”‚
â”‚     â”œâ”€ Payment method selector                           â”‚
â”‚     â””â”€ Stripe/PayPal checkout                            â”‚
â”‚                                                             â”‚
â”‚  app/booking/confirmation/page.tsx (200 lines)           â”‚
â”‚  â””â”€ Confirmation page                                    â”‚
â”‚     â”œâ”€ Booking details                                   â”‚
â”‚     â”œâ”€ Payment receipt                                   â”‚
â”‚     â”œâ”€ Download receipt button                           â”‚
â”‚     â””â”€ Next steps                                        â”‚
â”‚                                                             â”‚
â”‚  Total: ~450 lines of new page code                     â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              NEW API ROUTES (Week 2)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  PAYPAL INTEGRATION:                                       â”‚
â”‚  app/api/payments/paypal/                                 â”‚
â”‚  â”œâ”€ create/route.ts     (150 lines) - Create order       â”‚
â”‚  â”œâ”€ capture/route.ts    (150 lines) - Capture payment    â”‚
â”‚  â””â”€ webhook/route.ts    (180 lines) - Webhook handling   â”‚
â”‚                                                             â”‚
â”‚  STRIPE WEBHOOKS (UPDATE):                                â”‚
â”‚  app/api/payments/webhook/route.ts (180 lines)           â”‚
â”‚  â””â”€ Enhanced with more event types                       â”‚
â”‚                                                             â”‚
â”‚  Total: ~660 lines of new backend code                  â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              NEW LIBRARIES (Week 2)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  lib/paypal.ts                  (250 lines)               â”‚
â”‚  â”œâ”€ createPayPalOrder()                                  â”‚
â”‚  â”œâ”€ capturePayPalOrder()                                 â”‚
â”‚  â”œâ”€ refundPayPalOrder()                                  â”‚
â”‚  â””â”€ verifyPayPalWebhook()                                â”‚
â”‚                                                             â”‚
â”‚  lib/paymentHelpers.ts          (150 lines)               â”‚
â”‚  â”œâ”€ Format amounts                                       â”‚
â”‚  â”œâ”€ Validate payments                                    â”‚
â”‚  â””â”€ Handle errors                                        â”‚
â”‚                                                             â”‚
â”‚  Total: ~400 lines of payment logic                     â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ADMIN FEATURES (Week 3)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  app/admin/payments/                                       â”‚
â”‚  â”œâ”€ page.tsx                    (300 lines)               â”‚
â”‚  â”‚  â””â”€ Revenue dashboard + stats                         â”‚
â”‚  â”œâ”€ transactions/page.tsx       (250 lines)               â”‚
â”‚  â”‚  â””â”€ Searchable transaction list                       â”‚
â”‚  â”œâ”€ refunds/page.tsx            (250 lines)               â”‚
â”‚  â”‚  â””â”€ Refund management                                 â”‚
â”‚  â””â”€ reconciliation/page.tsx     (200 lines)               â”‚
â”‚     â””â”€ Payment reconciliation                            â”‚
â”‚                                                             â”‚
â”‚  Total: ~1000 lines of admin code                       â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              NEW SERVICES (Week 2)                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  External Service Integrations:                           â”‚
â”‚                                                             â”‚
â”‚  Stripe                          PayPal                    â”‚
â”‚  â”œâ”€ Test: pk_test_...           â”œâ”€ Test: sandbox app    â”‚
â”‚  â”œâ”€ Live: pk_live_...           â”œâ”€ Live: production app â”‚
â”‚  â”œâ”€ Webhooks: stripe.com        â”œâ”€ Webhooks: paypal.com â”‚
â”‚  â””â”€ Signature verify            â””â”€ Signature verify    â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              NEW ENVIRONMENT VARIABLES                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  Stripe:                         PayPal:                  â”‚
â”‚  â”œâ”€ NEXT_PUBLIC_STRIPE_PK       â”œâ”€ NEXT_PUBLIC_PAYPAL_IDâ”‚
â”‚  â”œâ”€ STRIPE_SECRET_KEY           â”œâ”€ PAYPAL_SECRET       â”‚
â”‚  â””â”€ STRIPE_WEBHOOK_SECRET       â””â”€ PAYPAL_WEBHOOK_ID   â”‚
â”‚                                                             â”‚
â”‚  Total: 6 new environment variables                      â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

SUMMARY:
â”œâ”€ ~3,100 lines of new code
â”œâ”€ 15+ new files/endpoints
â”œâ”€ 45 organized todos
â”œâ”€ 4-week timeline
â””â”€ ~74 hours of development
```

---

## Data Flow: Payment Processing

```
PAYMENT FLOW - From Booking to Confirmation
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. USER COMPLETES BOOKING
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Booking Page    â”‚
   â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
   â”‚ â”‚ Pickup      â”‚ â”‚
   â”‚ â”‚ Drop-off    â”‚ â”‚
   â”‚ â”‚ Vehicle     â”‚ â”‚
   â”‚ â”‚ Passengers  â”‚ â”‚
   â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Calculate Rate     â”‚
   â”‚ POST /rates/calc   â”‚
   â”‚ Response: $52 THB  â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Show Total      â”‚
   â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
   â”‚ â”‚ Base: $50   â”‚ â”‚
   â”‚ â”‚ Fees: $2    â”‚ â”‚
   â”‚ â”‚ Total: $52  â”‚ â”‚
   â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼

2. PAYMENT METHOD SELECTION
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Method Selector        â”‚
   â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
   â”‚ â”‚ â—‹ Stripe Card   â”‚ â—„â”€â”€â”¼â”€ DEFAULT
   â”‚ â”‚ â—‹ PayPal        â”‚   â”‚
   â”‚ â”‚ â—‹ Bank Transfer â”‚   â”‚
   â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
     â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
     â”‚             â”‚
     â–¼             â–¼
  (Stripe)      (PayPal)
     â”‚             â”‚

3. STRIPE FLOW
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Enter Card Details     â”‚
   â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
   â”‚ â”‚ 4242424242424242 â”‚   â”‚
   â”‚ â”‚ MM/YY CVC        â”‚   â”‚
   â”‚ â”‚ Billing address  â”‚   â”‚
   â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ POST /payments/create-intentâ”‚
   â”‚ â”œâ”€ bookingId               â”‚
   â”‚ â”œâ”€ amount: 5200 (cents)    â”‚
   â”‚ â””â”€ email: user@...         â”‚
   â”‚ Response:                  â”‚
   â”‚ â””â”€ clientSecret: pi_...    â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Stripe Processes       â”‚
   â”‚ (PCI-compliant)        â”‚
   â”‚ âœ“ Card validated       â”‚
   â”‚ âœ“ Amount authorized    â”‚
   â”‚ âœ“ Token created        â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Webhook Event          â”‚
   â”‚ payment_intent.        â”‚
   â”‚ succeeded              â”‚
   â”‚                        â”‚
   â”‚ POST /payments/webhook â”‚
   â”‚ â”œâ”€ Verify signature    â”‚
   â”‚ â”œâ”€ Update booking      â”‚
   â”‚ â””â”€ Send receipt email  â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼

4. PAYPAL FLOW (Similar)
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Click PayPal Button    â”‚
   â”‚ â”œâ”€ Redirect to PayPal  â”‚
   â”‚ â”œâ”€ User logs in        â”‚
   â”‚ â”œâ”€ User confirms       â”‚
   â”‚ â””â”€ Redirect back       â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ POST /paypal/capture       â”‚
   â”‚ â”œâ”€ orderId from PayPal     â”‚
   â”‚ â”œâ”€ Capture funds           â”‚
   â”‚ â””â”€ Update booking          â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼

5. CONFIRMATION
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Database Updated            â”‚
   â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
   â”‚ â”‚ Booking                  â”‚â”‚
   â”‚ â”‚ â”œâ”€ status: COMPLETED     â”‚â”‚
   â”‚ â”‚ â”œâ”€ paymentStatus: PAID   â”‚â”‚
   â”‚ â”‚ â”œâ”€ paymentId: pi_...     â”‚â”‚
   â”‚ â”‚ â”œâ”€ paymentAmount: 5200   â”‚â”‚
   â”‚ â”‚ â”œâ”€ paymentMethod: stripe â”‚â”‚
   â”‚ â”‚ â””â”€ paymentDate: 2025-... â”‚â”‚
   â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Email Sent                  â”‚
   â”‚ â”œâ”€ Booking confirmation     â”‚
   â”‚ â”œâ”€ Receipt                  â”‚
   â”‚ â”œâ”€ Next steps               â”‚
   â”‚ â””â”€ Support contact          â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ User Redirected             â”‚
   â”‚ /booking/confirmation       â”‚
   â”‚ â”œâ”€ Booking #12345           â”‚
   â”‚ â”œâ”€ Status: CONFIRMED âœ“      â”‚
   â”‚ â”œâ”€ Payment: $52 THB         â”‚
   â”‚ â”œâ”€ Download receipt         â”‚
   â”‚ â””â”€ What's next              â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Security & Compliance

```
PCI COMPLIANCE & SECURITY LAYERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Layer 1: Browser
â”œâ”€ HTTPS only
â”œâ”€ CSP Headers
â”œâ”€ XSS protection
â””â”€ CORS validation

Layer 2: Frontend
â”œâ”€ Stripe Elements (no raw card data)
â”œâ”€ Input validation
â”œâ”€ Rate limiting (client-side)
â””â”€ Error masking

Layer 3: API
â”œâ”€ API key rotation
â”œâ”€ Request validation
â”œâ”€ Webhook signature verification
â”œâ”€ Rate limiting (server-side)
â”œâ”€ Audit logging
â””â”€ Error handling

Layer 4: Database
â”œâ”€ Encrypted connection
â”œâ”€ Row-level security
â”œâ”€ Audit trails
â””â”€ Backup encryption

Layer 5: External
â”œâ”€ Stripe PCI Level 1
â”œâ”€ PayPal PCI compliance
â”œâ”€ TLS 1.2+
â””â”€ Certificate pinning

Result: PCI DSS Level 1 Compliance âœ“
```

---

## Timeline & Dependencies

```
DEPENDENCY GRAPH
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Week 1 (Setup + Stripe UI):
â””â”€ Setup env vars
   â”œâ”€ Build payment components
   â”‚  â””â”€ Integrate into booking
   â”‚     â””â”€ Manual testing
   â”‚        â””â”€ Ready for Week 2

Week 2 (PayPal + Email):
   â”œâ”€ DEPENDS ON Week 1 components
   â”œâ”€ Build PayPal integration
   â”‚  â”œâ”€ Create email templates
   â”‚  â”œâ”€ End-to-end testing
   â”‚  â””â”€ Ready for Week 3

Week 3 (Admin + Error):
   â”œâ”€ DEPENDS ON Week 2 APIs
   â”œâ”€ Build admin dashboard
   â”‚  â”œâ”€ Error handling
   â”‚  â”œâ”€ Monitoring setup
   â”‚  â””â”€ Ready for Week 4

Week 4 (Security + Deploy):
   â”œâ”€ DEPENDS ON Week 3 features
   â”œâ”€ Security audit
   â”‚  â”œâ”€ Performance testing
   â”‚  â”œâ”€ UAT testing
   â”‚  â””â”€ Production deployment

Launch âœ“
â””â”€ Monitor & support
```

---

**Next Steps:**

1. Review this architecture overview
2. Complete Vercel environment variable setup TODAY
3. Test production login
4. Tomorrow: Start Week 1 of Phase 2 (payment components)
5. Next 4 weeks: Follow the 45 detailed todos

**Questions?** Check the documentation in project root!
